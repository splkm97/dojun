<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Í∏∞ÏñµÏùò ÎßåÏ∞¨ - Ïò®ÎùºÏù∏</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                color: #fff;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 10px;
            }

            h1 {
                text-align: center;
                font-size: 2.5rem;
                margin-bottom: 10px;
                color: #ffd700;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }

            #game-screen h1 {
                font-size: 1.8rem;
                margin-bottom: 5px;
            }

            .game-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                padding: 8px 15px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }

            .player-info {
                text-align: center;
                padding: 5px 15px;
                border-radius: 8px;
                min-width: 120px;
            }

            .player-info.active {
                background: rgba(255, 215, 0, 0.3);
                border: 2px solid #ffd700;
            }

            .player-info.disconnected {
                opacity: 0.5;
            }

            .player-info h3 {
                margin-bottom: 3px;
                font-size: 0.95rem;
            }

            .player-info .tokens {
                font-size: 1.2rem;
                font-weight: bold;
            }

            .phase-info {
                text-align: center;
                padding: 5px 20px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 8px;
            }

            .phase-info h2 {
                color: #ffd700;
                margin-bottom: 3px;
                font-size: 1.1rem;
            }

            .timer {
                font-size: 1.5rem;
                font-weight: bold;
                color: #ff6b6b;
            }

            .timer.warning {
                animation: blink 0.5s infinite;
            }

            @keyframes blink {
                50% {
                    opacity: 0.5;
                }
            }

            .plates-container {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                margin-bottom: 10px;
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }

            .plate {
                aspect-ratio: 1;
                position: relative;
                cursor: pointer;
                transition: transform 0.2s;
            }

            .plate:hover:not(.disabled) {
                transform: scale(1.05);
            }

            .plate.disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }

            .plate-base {
                width: 100%;
                height: 100%;
                background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
                border-radius: 50%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 2px solid #ccc;
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            }

            .plate-number {
                font-size: 0.9rem;
                font-weight: bold;
                color: #333;
            }

            .token-count {
                font-size: 1.1rem;
                font-weight: bold;
                color: #e74c3c;
                margin-top: 2px;
            }

            .plate-cover {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(145deg, #8b4513, #654321);
                border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
                display: flex;
                justify-content: center;
                align-items: center;
                border: 2px solid #5d3a1a;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                transition:
                    transform 0.5s,
                    opacity 0.5s;
            }

            .plate-cover.open {
                transform: translateY(-100%) rotateX(60deg);
                opacity: 0;
            }

            .plate-cover .cover-number {
                font-size: 1.2rem;
                font-weight: bold;
                color: #ffd700;
            }

            .plate.selected .plate-cover {
                border-color: #ffd700;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }

            .plate.selected-first .plate-cover {
                border-color: #3498db;
                box-shadow: 0 0 20px rgba(52, 152, 219, 0.6);
            }

            .plate.selected-second .plate-cover {
                border-color: #e74c3c;
                box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
            }

            /* Opponent selection styling - purple/violet theme */
            .plate.opponent-selected-first .plate-cover {
                border-color: #9b59b6;
                box-shadow: 0 0 20px rgba(155, 89, 182, 0.6);
            }

            .plate.opponent-selected-second .plate-cover {
                border-color: #8e44ad;
                box-shadow: 0 0 20px rgba(142, 68, 173, 0.6);
            }

            /* Token placement/addition animation */
            .plate.just-placed {
                animation: plate-pulse 0.6s ease-out;
            }

            .plate.just-placed .plate-cover {
                border-color: #f39c12;
                box-shadow: 0 0 30px rgba(243, 156, 18, 0.9);
            }

            @keyframes plate-pulse {
                0% {
                    transform: scale(1);
                }
                30% {
                    transform: scale(1.15);
                }
                60% {
                    transform: scale(1.05);
                }
                100% {
                    transform: scale(1);
                }
            }

            .plate.token-added .plate-cover {
                border-color: #2ecc71;
                box-shadow: 0 0 25px rgba(46, 204, 113, 0.8);
                animation: pulse-green 0.3s ease-in-out 3;
            }

            @keyframes pulse-green {
                0%, 100% {
                    box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
                }
                50% {
                    box-shadow: 0 0 30px rgba(46, 204, 113, 1);
                }
            }

            .controls {
                text-align: center;
                margin-top: 10px;
            }

            .btn {
                padding: 10px 24px;
                font-size: 1rem;
                font-weight: bold;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
                margin: 5px;
            }

            .btn-primary {
                background: linear-gradient(145deg, #ffd700, #ffb700);
                color: #1a1a2e;
            }

            .btn-primary:hover {
                background: linear-gradient(145deg, #ffb700, #ffd700);
                transform: translateY(-2px);
            }

            .btn-secondary {
                background: linear-gradient(145deg, #3498db, #2980b9);
                color: #fff;
            }

            .btn-secondary:hover {
                background: linear-gradient(145deg, #2980b9, #3498db);
            }

            .btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .btn-danger {
                background: linear-gradient(145deg, #e74c3c, #c0392b);
                color: #fff;
            }

            .btn-danger:hover {
                background: linear-gradient(145deg, #c0392b, #e74c3c);
            }

            .leave-game-btn {
                position: fixed;
                bottom: 20px;
                left: 20px;
                font-size: 0.9rem;
                padding: 8px 16px;
                z-index: 100;
            }

            .modal-buttons {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-top: 20px;
            }

            .message {
                text-align: center;
                padding: 10px;
                margin: 8px auto;
                border-radius: 8px;
                font-size: 1rem;
                max-width: 600px;
            }

            .message.success {
                background: rgba(46, 204, 113, 0.3);
                border: 2px solid #2ecc71;
            }

            .message.fail {
                background: rgba(231, 76, 60, 0.3);
                border: 2px solid #e74c3c;
            }

            .message.info {
                background: rgba(52, 152, 219, 0.3);
                border: 2px solid #3498db;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal.show {
                display: flex;
            }

            .modal-content {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                padding: 40px;
                border-radius: 15px;
                text-align: center;
                border: 3px solid #ffd700;
                max-width: 500px;
            }

            .modal-content h2 {
                color: #ffd700;
                font-size: 2rem;
                margin-bottom: 20px;
            }

            .modal-content p {
                font-size: 1.2rem;
                margin-bottom: 20px;
            }

            .winner-announcement {
                font-size: 1.5rem;
                color: #2ecc71;
                margin: 20px 0;
            }

            .placement-info {
                background: rgba(255, 255, 255, 0.1);
                padding: 8px 15px;
                border-radius: 8px;
                margin: 8px auto;
                max-width: 600px;
                text-align: center;
            }

            .placement-info h3 {
                color: #ffd700;
                margin-bottom: 5px;
                font-size: 1rem;
            }

            .current-placement {
                font-size: 1rem;
            }

            .floating-confirm {
                position: fixed;
                right: 20px;
                bottom: 20px;
                z-index: 100;
                display: none;
            }

            .floating-confirm.show {
                display: block;
            }

            .floating-confirm .btn {
                padding: 15px 25px;
                font-size: 1.1rem;
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            }

            /* Lobby Screen */
            .lobby-screen {
                text-align: center;
                padding: 50px 20px;
            }

            .lobby-screen h1 {
                font-size: 3rem;
                margin-bottom: 10px;
            }

            .lobby-screen .subtitle {
                font-size: 1.2rem;
                color: #aaa;
                margin-bottom: 30px;
            }

            .lobby-panel {
                background: rgba(255, 255, 255, 0.1);
                padding: 30px;
                border-radius: 15px;
                max-width: 450px;
                margin: 0 auto 20px;
            }

            .lobby-panel h3 {
                color: #ffd700;
                margin-bottom: 20px;
                font-size: 1.3rem;
            }

            .input-group {
                margin-bottom: 20px;
            }

            .input-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 1rem;
            }

            .input-group input {
                width: 100%;
                padding: 12px 15px;
                font-size: 1rem;
                border: 2px solid #555;
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.3);
                color: #fff;
                outline: none;
                transition: border-color 0.3s;
            }

            .input-group input:focus {
                border-color: #ffd700;
            }

            .input-group input::placeholder {
                color: #888;
            }

            .lobby-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .btn-large {
                padding: 15px 30px;
                font-size: 1.2rem;
            }

            .divider {
                display: flex;
                align-items: center;
                margin: 25px 0;
            }

            .divider::before,
            .divider::after {
                content: "";
                flex: 1;
                border-bottom: 1px solid #555;
            }

            .divider span {
                padding: 0 15px;
                color: #888;
            }

            .room-code-input {
                display: flex;
                gap: 10px;
            }

            .room-code-input input {
                flex: 1;
                text-transform: uppercase;
                letter-spacing: 2px;
                text-align: center;
            }

            .connection-status {
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 8px 15px;
                border-radius: 20px;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .connection-status.connected {
                background: rgba(46, 204, 113, 0.3);
                border: 1px solid #2ecc71;
            }

            .connection-status.disconnected {
                background: rgba(231, 76, 60, 0.3);
                border: 1px solid #e74c3c;
            }

            .connection-status.connecting {
                background: rgba(255, 215, 0, 0.3);
                border: 1px solid #ffd700;
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
            }

            .connected .status-dot {
                background: #2ecc71;
            }

            .disconnected .status-dot {
                background: #e74c3c;
            }

            .connecting .status-dot {
                background: #ffd700;
                animation: pulse 1s infinite;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            /* Waiting Room */
            .waiting-room {
                text-align: center;
                padding: 50px 20px;
            }

            .waiting-room h2 {
                color: #ffd700;
                margin-bottom: 20px;
            }

            .room-code-display {
                font-size: 2.5rem;
                letter-spacing: 8px;
                color: #ffd700;
                background: rgba(0, 0, 0, 0.3);
                padding: 20px 40px;
                border-radius: 10px;
                display: inline-block;
                margin: 20px 0;
            }

            .waiting-message {
                font-size: 1.2rem;
                color: #aaa;
                margin: 20px 0;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #555;
                border-top: 4px solid #ffd700;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 20px auto;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .add-token-selection {
                display: none;
                margin-top: 15px;
            }

            .add-token-selection.show {
                display: block;
            }

            .add-token-selection p {
                margin-bottom: 10px;
                color: #ffd700;
            }

            /* Mobile responsive */
            @media (max-width: 768px) {
                .container {
                    padding: 10px;
                }

                h1 {
                    font-size: 1.8rem;
                }

                .lobby-screen h1 {
                    font-size: 2rem;
                }

                .game-info {
                    flex-direction: column;
                    gap: 10px;
                    padding: 10px;
                }

                .player-info {
                    width: 100%;
                }

                .phase-info {
                    order: -1;
                    width: 100%;
                }

                .plates-container {
                    gap: 6px;
                }

                .plate-number {
                    font-size: 0.8rem;
                }

                .token-count {
                    font-size: 1rem;
                }

                .plate-cover .cover-number {
                    font-size: 1.1rem;
                }

                .room-code-display {
                    font-size: 2rem;
                    letter-spacing: 5px;
                    padding: 15px 25px;
                }
            }

            @media (max-width: 480px) {
                h1 {
                    font-size: 1.5rem;
                }

                .plates-container {
                    gap: 4px;
                }

                .plate-number {
                    font-size: 0.7rem;
                }

                .token-count {
                    font-size: 0.85rem;
                }

                .plate-cover .cover-number {
                    font-size: 0.9rem;
                }

                .btn {
                    padding: 8px 16px;
                    font-size: 0.9rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="container" id="app">
            <!-- Connection Status -->
            <div class="connection-status connecting" id="connection-status">
                <div class="status-dot"></div>
                <span>Ïó∞Í≤∞ Ï§ë...</span>
            </div>

            <!-- Lobby Screen -->
            <div id="lobby-screen" class="lobby-screen">
                <h1>Í∏∞ÏñµÏùò ÎßåÏ∞¨</h1>
                <p class="subtitle">Ïò®ÎùºÏù∏ Î©ÄÌã∞ÌîåÎ†àÏù¥Ïñ¥</p>

                <div class="lobby-panel">
                    <h3>Í≤åÏûÑ Ï∞∏Ïó¨</h3>
                    <div class="input-group">
                        <label for="nickname">ÎãâÎÑ§ÏûÑ</label>
                        <input type="text" id="nickname" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="12" />
                    </div>

                    <div class="lobby-buttons">
                        <button class="btn btn-primary btn-large" onclick="game.joinQueue()">
                            üé≤ ÎûúÎç§ Îß§Ïπ≠
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="game.createRoom()">
                            üè† Î∞© ÎßåÎì§Í∏∞
                        </button>
                    </div>

                    <div class="divider">
                        <span>ÎòêÎäî</span>
                    </div>

                    <div class="input-group">
                        <label for="room-code">Î∞© ÏΩîÎìúÎ°ú Ï∞∏Ïó¨</label>
                        <div class="room-code-input">
                            <input type="text" id="room-code" placeholder="ABCD12" maxlength="6" />
                            <button class="btn btn-secondary" onclick="game.joinRoom()">Ï∞∏Ïó¨</button>
                        </div>
                    </div>
                </div>

                <div class="lobby-panel" style="background: rgba(255, 255, 255, 0.05);">
                    <h3>Í≤åÏûÑ Í∑úÏπô</h3>
                    <ul style="text-align: left; margin-left: 20px; line-height: 1.8;">
                        <li><strong>Î∞∞Ïπò Îã®Í≥Ñ:</strong> Î≤àÍ∞àÏïÑÍ∞ÄÎ©∞ Ï†ëÏãúÏóê ÌÜ†ÌÅ∞ Î∞∞Ïπò</li>
                        <li><strong>Îß§Ïπ≠ Îã®Í≥Ñ:</strong> 60Ï¥à ÏïàÏóê Í∞ôÏùÄ ÌÜ†ÌÅ∞ ÏàòÏùò Ï†ëÏãú 2Í∞ú Ï∞æÍ∏∞</li>
                        <li><strong>ÏÑ±Í≥µ:</strong> ÌÜ†ÌÅ∞ 1Í∞úÎ•º Ï†ëÏãúÏóê Ï∂îÍ∞Ä (Î≥¥Ïú† ÌÜ†ÌÅ∞ -1)</li>
                        <li><strong>Ïã§Ìå®/ÏãúÍ∞ÑÏ¥àÍ≥º:</strong> ÌéòÎÑêÌã∞ ÌÜ†ÌÅ∞ Î∞õÍ∏∞</li>
                        <li><strong>ÏäπÎ¶¨:</strong> ÌÜ†ÌÅ∞ÏùÑ Î®ºÏ†Ä ÏÜåÏßÑÌïú ÌîåÎ†àÏù¥Ïñ¥ ÏäπÎ¶¨!</li>
                    </ul>
                </div>
            </div>

            <!-- Waiting Room Screen -->
            <div id="waiting-screen" style="display: none;">
                <div class="waiting-room">
                    <h2 id="waiting-title">ÎåÄÍ∏∞ Ï§ë...</h2>
                    <div id="room-code-display" class="room-code-display" style="display: none;"></div>
                    <p class="waiting-message" id="waiting-message">ÏÉÅÎåÄÎ•º Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§...</p>
                    <div class="spinner"></div>
                    <button class="btn btn-secondary" onclick="game.cancelWaiting()">Ï∑®ÏÜå</button>
                </div>
            </div>

            <!-- Game Screen -->
            <div id="game-screen" style="display: none">
                <h1>Í∏∞ÏñµÏùò ÎßåÏ∞¨</h1>

                <div class="game-info">
                    <div class="player-info" id="player0-info">
                        <h3 id="player0-name">ÌîåÎ†àÏù¥Ïñ¥ 1</h3>
                        <div class="tokens" id="player0-tokens">-</div>
                    </div>

                    <div class="phase-info">
                        <h2 id="phase-title">Î∞∞Ïπò Îã®Í≥Ñ</h2>
                        <div id="phase-description"></div>
                        <div class="timer" id="timer" style="display: none">60</div>
                    </div>

                    <div class="player-info" id="player1-info">
                        <h3 id="player1-name">ÌîåÎ†àÏù¥Ïñ¥ 2</h3>
                        <div class="tokens" id="player1-tokens">-</div>
                    </div>
                </div>

                <div class="placement-info" id="placement-info">
                    <h3>ÌòÑÏû¨ Î∞∞Ïπò</h3>
                    <div class="current-placement" id="current-placement"></div>
                </div>

                <div id="message-area"></div>

                <div class="plates-container" id="plates-container"></div>

                <div class="add-token-selection" id="add-token-selection">
                    <p>ÌÜ†ÌÅ∞ÏùÑ Ï∂îÍ∞ÄÌï† Ï†ëÏãúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:</p>
                </div>

                <button class="btn btn-danger leave-game-btn" onclick="game.showLeaveConfirm()">
                    ÎÇòÍ∞ÄÍ∏∞
                </button>
            </div>

            <!-- Leave Confirmation Modal -->
            <div class="modal" id="leave-confirm-modal">
                <div class="modal-content">
                    <h2>Í≤åÏûÑÏùÑ ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?</h2>
                    <p>ÎÇòÍ∞ÄÎ©¥ ÏÉÅÎåÄÎ∞©Ïù¥ ÏäπÎ¶¨ÌïòÍ≤å Îê©ÎãàÎã§.</p>
                    <div class="modal-buttons">
                        <button class="btn btn-secondary" onclick="game.hideLeaveConfirm()">Ï∑®ÏÜå</button>
                        <button class="btn btn-danger" onclick="game.confirmLeave()">ÎÇòÍ∞ÄÍ∏∞</button>
                    </div>
                </div>
            </div>

            <!-- Floating Confirm Button -->
            <div class="floating-confirm" id="floating-confirm">
                <button class="btn btn-primary" onclick="game.confirmSelection()">
                    ÏÑ†ÌÉù ÌôïÏù∏
                </button>
            </div>

            <!-- Result Modal -->
            <div class="modal" id="result-modal">
                <div class="modal-content">
                    <h2 id="result-title">Í≤åÏûÑ Ï¢ÖÎ£å!</h2>
                    <div class="winner-announcement" id="winner-announcement"></div>
                    <p id="result-description"></p>
                    <button class="btn btn-primary" onclick="game.backToLobby()">
                        Î°úÎπÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                    </button>
                </div>
            </div>
        </div>

        <script>
            class OnlineMemoryFeast {
                constructor() {
                    this.ws = null;
                    this.sessionId = localStorage.getItem('sessionId') || this.generateSessionId();
                    localStorage.setItem('sessionId', this.sessionId);

                    this.roomId = null;
                    this.roomCode = null;
                    this.playerIndex = -1;
                    this.gameState = null;
                    this.placementPending = false; // Lock to prevent multiple clicks during placement

                    this.connect();
                }

                generateSessionId() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                connect() {
                    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${location.host}/ws?sessionId=${this.sessionId}`;

                    this.updateConnectionStatus('connecting');

                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        this.updateConnectionStatus('connected');

                        // Attempt to reconnect to any active game
                        this.send({
                            type: 'reconnect',
                            payload: { sessionId: this.sessionId }
                        });
                    };

                    this.ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.updateConnectionStatus('disconnected');
                        // Attempt reconnection
                        setTimeout(() => this.connect(), 3000);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateConnectionStatus('disconnected');
                    };

                    this.ws.onmessage = (event) => {
                        const msg = JSON.parse(event.data);
                        this.handleMessage(msg);
                    };
                }

                send(msg) {
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify(msg));
                    }
                }

                updateConnectionStatus(status) {
                    const el = document.getElementById('connection-status');
                    el.className = 'connection-status ' + status;
                    const labels = {
                        connected: 'Ïó∞Í≤∞Îê®',
                        disconnected: 'Ïó∞Í≤∞ ÎÅäÍπÄ',
                        connecting: 'Ïó∞Í≤∞ Ï§ë...'
                    };
                    el.querySelector('span').textContent = labels[status];
                }

                handleMessage(msg) {
                    console.log('Received:', msg.type, msg.payload);

                    switch (msg.type) {
                        case 'error':
                            this.handleError(msg.payload);
                            break;
                        case 'queue_joined':
                            this.handleQueueJoined(msg.payload);
                            break;
                        case 'matched':
                            this.handleMatched(msg.payload);
                            break;
                        case 'room_created':
                            this.handleRoomCreated(msg.payload);
                            break;
                        case 'room_joined':
                            this.handleRoomJoined(msg.payload);
                            break;
                        case 'game_state':
                            this.handleGameState(msg.payload);
                            break;
                        case 'game_end':
                            this.handleGameEnd(msg.payload);
                            break;
                        case 'player_left':
                            this.handlePlayerLeft(msg.payload);
                            break;
                        case 'reconnected':
                            this.handleReconnected(msg.payload);
                            break;
                    }
                }

                handleError(payload) {
                    // Ignore expected errors during reconnect attempt
                    if (payload.code === 'no_active_game') {
                        return; // Normal when no game to reconnect to
                    }
                    alert(`Ïò§Î•ò: ${payload.message}`);
                    if (payload.code === 'room_not_found' || payload.code === 'room_full') {
                        this.showScreen('lobby');
                    }
                }

                handleQueueJoined(payload) {
                    this.showScreen('waiting');
                    document.getElementById('waiting-title').textContent = 'ÎûúÎç§ Îß§Ïπ≠';
                    document.getElementById('waiting-message').textContent = `ÎåÄÍ∏∞Ïó¥ ${payload.position}Î≤àÏß∏`;
                    document.getElementById('room-code-display').style.display = 'none';
                }

                handleMatched(payload) {
                    this.roomId = payload.roomId;
                    this.roomCode = payload.roomCode;
                    this.playerIndex = payload.playerIndex;
                    this.opponentName = payload.opponent;
                    // Game screen will be shown when game_state is received
                }

                handleRoomCreated(payload) {
                    this.roomId = payload.roomId;
                    this.roomCode = payload.roomCode;
                    this.playerIndex = 0;

                    this.showScreen('waiting');
                    document.getElementById('waiting-title').textContent = 'Î∞© ÏÉùÏÑ±Îê®';
                    document.getElementById('room-code-display').textContent = payload.roomCode;
                    document.getElementById('room-code-display').style.display = 'block';
                    document.getElementById('waiting-message').textContent = 'Ïù¥ ÏΩîÎìúÎ•º ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Í≥µÏú†ÌïòÏÑ∏Ïöî';
                }

                handleRoomJoined(payload) {
                    this.roomId = payload.roomId;
                    this.roomCode = payload.roomCode;
                    this.playerIndex = payload.playerIndex;
                    this.opponentName = payload.opponent;
                }

                handleGameState(payload) {
                    this.gameState = payload;
                    this.placementPending = false; // Reset click lock on state update
                    this.showScreen('game');
                    this.renderGameState();
                }

                handleGameEnd(payload) {
                    const modal = document.getElementById('result-modal');
                    const title = document.getElementById('result-title');
                    const announcement = document.getElementById('winner-announcement');
                    const description = document.getElementById('result-description');

                    title.textContent = 'Í≤åÏûÑ Ï¢ÖÎ£å!';

                    if (payload.winner === 0) {
                        announcement.textContent = 'Î¨¥ÏäπÎ∂Ä!';
                        description.textContent = `ÌîåÎ†àÏù¥Ïñ¥ 1: ${payload.finalTokens[0]}Í∞ú, ÌîåÎ†àÏù¥Ïñ¥ 2: ${payload.finalTokens[1]}Í∞ú`;
                    } else {
                        announcement.textContent = `${payload.winnerName} ÏäπÎ¶¨!`;

                        const reasons = {
                            tokens: 'Î™®Îì† ÌÜ†ÌÅ∞ÏùÑ ÏÜåÏßÑÌñàÏäµÎãàÎã§!',
                            no_matches: 'Îçî Ïù¥ÏÉÅ Îß§Ïπ≠ Í∞ÄÎä•Ìïú ÏåçÏù¥ ÏóÜÏäµÎãàÎã§.',
                            forfeit: 'ÏÉÅÎåÄÎ∞©Ïù¥ Í≤åÏûÑÏùÑ ÎÇòÍ∞îÏäµÎãàÎã§.'
                        };
                        description.textContent = reasons[payload.reason] || '';
                    }

                    modal.classList.add('show');
                }

                handlePlayerLeft(payload) {
                    this.showMessage(`ÏÉÅÎåÄÎ∞©Ïù¥ Ïó∞Í≤∞ÏùÑ ÎÅäÏóàÏäµÎãàÎã§. ${payload.gracePeriod}Ï¥à ÎÇ¥Ïóê Ïû¨Ï†ëÏÜçÌïòÏßÄ ÏïäÏúºÎ©¥ ÏäπÎ¶¨Ìï©ÎãàÎã§.`, 'info');
                }

                handleReconnected(payload) {
                    // Restore player index from server
                    this.playerIndex = payload.playerIndex;
                    this.showMessage('Ïû¨Ï†ëÏÜçÏóê ÏÑ±Í≥µÌñàÏäµÎãàÎã§!', 'success');
                    // Game state will follow automatically from server
                }

                renderGameState() {
                    if (!this.gameState) return;

                    const state = this.gameState;

                    // Update player info
                    for (let i = 0; i < 2; i++) {
                        const player = state.players[i];
                        const infoEl = document.getElementById(`player${i}-info`);
                        const nameEl = document.getElementById(`player${i}-name`);
                        const tokensEl = document.getElementById(`player${i}-tokens`);

                        nameEl.textContent = player.nickname || `ÌîåÎ†àÏù¥Ïñ¥ ${i + 1}`;

                        if (state.phase === 'placement') {
                            tokensEl.textContent = 'Î∞∞Ïπò Ï§ë';
                        } else {
                            tokensEl.textContent = `${player.tokens}Í∞ú`;
                        }

                        infoEl.classList.toggle('active', state.currentTurn === i);
                        infoEl.classList.toggle('disconnected', !player.isConnected);
                    }

                    // Update phase info
                    const phaseTitle = document.getElementById('phase-title');
                    const phaseDesc = document.getElementById('phase-description');
                    const placementInfo = document.getElementById('placement-info');
                    const currentPlacement = document.getElementById('current-placement');
                    const timerEl = document.getElementById('timer');

                    const isMyTurn = state.currentTurn === this.playerIndex;
                    const currentPlayerName = state.players[state.currentTurn]?.nickname || `ÌîåÎ†àÏù¥Ïñ¥ ${state.currentTurn + 1}`;

                    if (state.phase === 'placement') {
                        phaseTitle.textContent = 'Î∞∞Ïπò Îã®Í≥Ñ';
                        phaseDesc.textContent = isMyTurn ? 'ÎãπÏã†Ïùò Ï∞®Î°ÄÏûÖÎãàÎã§' : `${currentPlayerName}Ïùò Ï∞®Î°Ä`;
                        placementInfo.style.display = 'block';
                        currentPlacement.textContent = `${state.placementRound}Í∞úÏùò ÌÜ†ÌÅ∞ÏùÑ Î∞∞ÏπòÌïòÏÑ∏Ïöî (ÎùºÏö¥Îìú ${state.placementRound}/${state.maxRound})`;
                        timerEl.style.display = 'none';
                    } else if (state.phase === 'matching' || state.phase === 'add_token') {
                        phaseTitle.textContent = state.phase === 'add_token' ? 'ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä' : 'Îß§Ïπ≠ Îã®Í≥Ñ';
                        phaseDesc.textContent = isMyTurn ? 'ÎãπÏã†Ïùò Ï∞®Î°ÄÏûÖÎãàÎã§' : `${currentPlayerName}Ïùò Ï∞®Î°Ä`;
                        placementInfo.style.display = 'none';
                        timerEl.style.display = 'block';
                        timerEl.textContent = state.timeLeft;
                        timerEl.classList.toggle('warning', state.timeLeft <= 10);
                    }

                    // Update plates
                    this.renderPlates();

                    // Update confirm button
                    this.updateConfirmButton();

                    // Update add token selection
                    const addTokenEl = document.getElementById('add-token-selection');
                    addTokenEl.classList.toggle('show', state.phase === 'add_token' && isMyTurn);

                    // Show message if present
                    if (state.message) {
                        this.showMessage(state.message, state.messageType || 'info');
                    }
                }

                renderPlates() {
                    const container = document.getElementById('plates-container');
                    const state = this.gameState;
                    if (!state) return;

                    container.innerHTML = '';

                    // Determine grid columns based on plate count
                    const plateCount = state.plates.length;
                    let columns = 5;
                    if (plateCount <= 4) columns = 2;
                    else if (plateCount <= 8) columns = 4;
                    else if (plateCount <= 12) columns = 4;
                    container.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;

                    state.plates.forEach((plate, index) => {
                        const plateEl = document.createElement('div');
                        plateEl.className = 'plate';
                        plateEl.dataset.index = index;

                        const isMyTurn = state.currentTurn === this.playerIndex;

                        // Disable plate if not clickable
                        if (state.phase === 'placement' && plate.hasTokens) {
                            plateEl.classList.add('disabled');
                        }
                        if (!isMyTurn) {
                            plateEl.classList.add('disabled');
                        }

                        // Selection styling (my selections)
                        if (state.selectedPlates && state.selectedPlates.includes(index)) {
                            if (state.selectedPlates[0] === index) {
                                plateEl.classList.add('selected-first');
                            } else {
                                plateEl.classList.add('selected-second');
                            }
                        }

                        // Opponent selection styling
                        if (state.opponentSelectedPlates && state.opponentSelectedPlates.includes(index)) {
                            if (state.opponentSelectedPlates[0] === index) {
                                plateEl.classList.add('opponent-selected-first');
                            } else {
                                plateEl.classList.add('opponent-selected-second');
                            }
                        }

                        // Matched plates styling
                        if (state.matchedPlates && state.matchedPlates.includes(index)) {
                            plateEl.classList.add('selected');
                        }

                        // Last action animation (placement or addition)
                        if (state.lastActionPlate === index) {
                            plateEl.classList.add('just-placed');
                        }

                        plateEl.innerHTML = `
                            <div class="plate-base">
                                <span class="plate-number">${index + 1}Î≤à</span>
                                <span class="token-count">${plate.tokens}Í∞ú</span>
                            </div>
                            <div class="plate-cover ${!plate.covered ? 'open' : ''}">
                                <span class="cover-number">${index + 1}</span>
                            </div>
                        `;

                        plateEl.addEventListener('click', () => this.onPlateClick(index));
                        container.appendChild(plateEl);
                    });
                }

                onPlateClick(index) {
                    if (!this.gameState) return;

                    const state = this.gameState;
                    const isMyTurn = state.currentTurn === this.playerIndex;

                    if (!isMyTurn) return;

                    if (state.phase === 'placement') {
                        if (state.plates[index].hasTokens) return;
                        if (this.placementPending) return; // Block multiple clicks
                        this.placementPending = true; // Lock until state update
                        this.send({
                            type: 'place_token',
                            payload: { index }
                        });
                    } else if (state.phase === 'matching') {
                        this.send({
                            type: 'select_plate',
                            payload: { index }
                        });
                    } else if (state.phase === 'add_token') {
                        if (!state.matchedPlates.includes(index)) return;
                        this.send({
                            type: 'add_token',
                            payload: { index }
                        });
                    }
                }

                updateConfirmButton() {
                    const floatingBtn = document.getElementById('floating-confirm');
                    const state = this.gameState;

                    if (!state) {
                        floatingBtn.classList.remove('show');
                        return;
                    }

                    const isMyTurn = state.currentTurn === this.playerIndex;
                    const shouldShow = state.phase === 'matching' &&
                                       isMyTurn &&
                                       state.selectedPlates.length === 2;

                    floatingBtn.classList.toggle('show', shouldShow);
                }

                confirmSelection() {
                    this.send({
                        type: 'confirm_match',
                        payload: {}
                    });
                }

                joinQueue() {
                    const nickname = document.getElementById('nickname').value.trim();
                    if (!nickname) {
                        alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                        return;
                    }

                    this.send({
                        type: 'join_queue',
                        payload: { nickname, sessionId: this.sessionId }
                    });
                }

                createRoom() {
                    const nickname = document.getElementById('nickname').value.trim();
                    if (!nickname) {
                        alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                        return;
                    }

                    this.send({
                        type: 'create_room',
                        payload: { nickname, sessionId: this.sessionId, plateCount: 20 }
                    });
                }

                joinRoom() {
                    const nickname = document.getElementById('nickname').value.trim();
                    const roomCode = document.getElementById('room-code').value.trim().toUpperCase();

                    if (!nickname) {
                        alert('ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                        return;
                    }
                    if (!roomCode || roomCode.length !== 6) {
                        alert('Ïú†Ìö®Ìïú Î∞© ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                        return;
                    }

                    this.send({
                        type: 'join_room',
                        payload: { nickname, sessionId: this.sessionId, roomCode }
                    });
                }

                cancelWaiting() {
                    this.send({
                        type: 'leave_room',
                        payload: {}
                    });
                    this.showScreen('lobby');
                    this.roomId = null;
                    this.roomCode = null;
                }

                backToLobby() {
                    document.getElementById('result-modal').classList.remove('show');
                    this.showScreen('lobby');
                    this.roomId = null;
                    this.roomCode = null;
                    this.gameState = null;
                }

                showLeaveConfirm() {
                    document.getElementById('leave-confirm-modal').classList.add('show');
                }

                hideLeaveConfirm() {
                    document.getElementById('leave-confirm-modal').classList.remove('show');
                }

                confirmLeave() {
                    this.hideLeaveConfirm();
                    this.send({
                        type: 'leave_room',
                        payload: {}
                    });
                    // Server will send game_end with forfeit, which triggers result modal
                }

                showScreen(screen) {
                    document.getElementById('lobby-screen').style.display = screen === 'lobby' ? 'block' : 'none';
                    document.getElementById('waiting-screen').style.display = screen === 'waiting' ? 'block' : 'none';
                    document.getElementById('game-screen').style.display = screen === 'game' ? 'block' : 'none';
                }

                showMessage(text, type) {
                    const area = document.getElementById('message-area');
                    area.innerHTML = `<div class="message ${type}">${text}</div>`;
                    setTimeout(() => {
                        area.innerHTML = '';
                    }, 3000);
                }
            }

            const game = new OnlineMemoryFeast();
            window.game = game;
        </script>
    </body>
</html>
